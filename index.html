<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title> D-earning app </title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --secondary-color: #6f42c1; 
            --secondary-hover-color: #5a32a3;
            --accent-color: #ffc107; 
            --accent-hover-color: #e0a800;
            --accent-text-color: #212529; 
            --success-color: #28a745; 
            --success-hover-color: #1e7e34;
            --info-color: #17a2b8;    
            --info-hover-color: #117a8b;
            --danger-color: #dc3545;  
            --danger-hover-color: #b02a37;
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --container-bg: white;
            --body-bg-start: #eef1f5; 
            --body-bg-end: #d9e0e7;   
            --font-family: 'Poppins', Arial, sans-serif;
            --border-radius-md: 10px; 
            --border-radius-lg: 16px; 
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.12);
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--body-bg-start) 0%, var(--body-bg-end) 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--dark-text);
            overflow-x: hidden; 
        }
        
        .auth-container, .admin-panel, .container {
            background-color: var(--container-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: 25px 30px;
            width: 90%;
            max-width: 400px; 
            text-align: center;
            margin-bottom: 25px; 
            border-top: 4px solid var(--primary-color); 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .auth-container:hover, .admin-panel:hover, .container:hover {
            box-shadow: var(--shadow-lg);
        }

        .auth-container h1, .admin-panel h2, .container h1 {
            margin-top: 0;
            margin-bottom: 25px;
            color: var(--dark-text);
            font-weight: 700;
        }
        .container h1 { font-size: 2.2em; }
        .auth-container h1 { font-size: 1.8em; }
        
        .coin-display {
            font-size: 2em; 
            font-weight: 700; 
            margin-bottom: 35px;
            color: var(--success-color);
            background-color: var(--light-bg);
            padding: 18px 25px;
            border-radius: var(--border-radius-md);
            display: inline-block; 
            border: 1px solid #d1d9e0;
            box-shadow: var(--shadow-sm), inset 0 1px 3px rgba(0,0,0,0.06);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        .coin-display::before { 
            content: "üí∞";
            margin-right: 12px;
            font-size: 1.2em; 
        }
        .coin-update-animation {
            animation: coinPulse 0.6s ease-out;
        }
        @keyframes coinPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.15); background-color: var(--accent-color); color: var(--accent-text-color); box-shadow: 0 0 15px rgba(255,193,7,0.5); }
            100% { transform: scale(1); background-color: var(--light-bg); color: var(--success-color); }
        }
        
        .btn, .auth-btn {
            color: white; border: none; padding: 14px 20px; 
            border-radius: var(--border-radius-md); font-size: 1.05em; 
            font-weight: 600; cursor: pointer; margin: 10px 0; 
            width: 100%; transition: all 0.25s ease-in-out;
            box-shadow: var(--shadow-sm); text-align: center; 
            letter-spacing: 0.5px;
            display: flex; /* For aligning icon and text */
            align-items: center; /* For aligning icon and text */
            justify-content: center; /* For aligning icon and text */
        }
        .btn:hover, .auth-btn:hover {
            transform: translateY(-3px) scale(1.02); 
            box-shadow: var(--shadow-md);
        }
        .btn:active, .auth-btn:active {
            transform: translateY(0px) scale(1); box-shadow: var(--shadow-sm);
        }
        .auth-btn { margin-top: 15px; background-color: var(--primary-color); } /* Adjusted margin */
        .auth-btn:hover { background-color: var(--primary-hover-color); }
        .btn:disabled, .auth-btn:disabled {
            background-color: #b0bec5; color: #78909c;
            box-shadow: none; transform: none; cursor: not-allowed;
        }
        .container .btn { background-color: var(--primary-color); }
        .container .btn:hover { background-color: var(--primary-hover-color); }
        .container #spinBtn {
            background-color: var(--accent-color); color: var(--accent-text-color); 
            font-size: 1.2em; padding: 16px 22px; font-weight: 700; 
        }
        .container #spinBtn:hover { background-color: var(--accent-hover-color); }
        .container #withdrawBtn { background-color: var(--success-color); }
        .container #withdrawBtn:hover { background-color: var(--success-hover-color); }
        .container #historyBtn { background-color: var(--info-color); }
        .container #historyBtn:hover { background-color: var(--info-hover-color); }
        .container .share-btn { background-color: var(--secondary-color); }
        .container .share-btn:hover { background-color: var(--secondary-hover-color); }
        .container .logout-btn { background-color: var(--danger-color); }
        .container .logout-btn:hover { background-color: var(--danger-hover-color); }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); 
            z-index: 1000; justify-content: center; align-items: center;
            overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background-color: white; padding: 30px; 
            border-radius: var(--border-radius-lg); 
            width: 90%; max-width: 400px; text-align: center;
            margin: 20px auto; box-shadow: var(--shadow-lg);
            border-top: 4px solid var(--primary-color); 
            animation: modalFadeIn 0.4s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-content h2 {
            margin-top: 0; margin-bottom: 20px; color: var(--dark-text); font-size: 1.6em;
        }
        .close-btn { 
            background-color: var(--secondary-color); color: white;
            border: none; padding: 10px 20px; border-radius: var(--border-radius-md);
            margin-top: 20px; cursor: pointer; font-weight: 500;
            transition: background-color 0.2s, transform 0.2s;
            width: auto; min-width: 120px;
        }
        .close-btn:hover {
            background-color: var(--secondary-hover-color); transform: translateY(-2px);
        }
        
        .wheel-container { width: 280px; height: 280px; position: relative; margin: 25px auto; }
        .wheel {
            width: 100%; height: 100%; border-radius: 50%;
            position: relative; overflow: hidden; 
            border: 6px solid #455a64; box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transition: transform 4s cubic-bezier(0.22, 0.61, 0.36, 1); 
        }
        .wheel-center {
            position: absolute; width: 45px; height: 45px;
            background-color: #455a64; border-radius: 50%;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; border: 4px solid white;
        }
        .wheel-static-pointer {
            position: absolute; width: 0; height: 0;
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-top: 25px solid var(--danger-color); 
            top: -15px; left: 50%; transform: translateX(-50%) rotate(180deg); 
            z-index: 20; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.4));
        }
        .wheel-text-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform-origin: center center; 
            pointer-events: none; 
            z-index: 3; 
        }
        .wheel-text-content {
            display: block; 
            position: absolute;
            top: 15%; 
            left: 50%; 
            transform: translateX(-50%) rotate(90deg); 
            font-weight: bold;
            color: white;
            font-size: 15px; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8); 
        }
        
        .input-field { 
            width: calc(100% - 24px); padding: 14px; margin: 12px 0;
            border: 1px solid #bcccdc; border-radius: var(--border-radius-md);
            font-size: 1em; font-family: var(--font-family);
            box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.2); outline: none;
        }

        .admin-btn-fixed { 
            position: fixed; bottom: 20px; right: 20px; 
            background-color: var(--dark-text); color: white; border: none;
            padding: 10px 15px; border-radius: 50px; 
            font-size: 0.9em; cursor: pointer; box-shadow: var(--shadow-md);
            transition: all 0.2s; z-index: 999;
        }
        .admin-btn-fixed:hover { background-color: #000; transform: scale(1.05); }
       
        .withdrawal-item, .history-item, .user-list-item {
            background-color: #fdfdff; padding: 15px; margin: 12px 0; 
            border-radius: var(--border-radius-md); text-align: left; 
            border: 1px solid #e0e6ec; box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .withdrawal-item:hover, .history-item:hover, .user-list-item:hover {
            transform: translateY(-2px); box-shadow: var(--shadow-md);
        }
        .withdrawal-item p, .history-item p, .user-list-item p {
            margin: 8px 0; font-size: 0.98em; line-height: 1.5;
        }
        .history-item p strong, .withdrawal-item p strong, .user-list-item p strong {
            color: var(--dark-text); margin-right: 5px;
            min-width: 80px; display: inline-block;
        }
        .status-pending::before { content: "‚è≥ "; font-size: 1.1em; vertical-align: middle; }
        .status-approved::before { content: "‚úÖ "; font-size: 1.1em; vertical-align: middle; }
        .status-rejected::before { content: "‚ùå "; font-size: 1.1em; vertical-align: middle; }
        .status-pending { color: #ff9800; } 
        .status-approved { color: var(--success-color); }
        .status-rejected { color: var(--danger-color); }

        .action-btn { 
            color: white; border: none; padding: 8px 12px; 
            border-radius: 6px; margin-top: 10px; margin-right: 8px; 
            cursor: pointer; font-size: 0.9em; font-weight: 500;
            transition: opacity 0.2s, transform 0.2s;
        }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .approve-btn { background-color: var(--success-color); }
        .reject-btn { background-color: var(--danger-color); }
        
        #historyList, #adminUsersListDiv {
            max-height: 350px; overflow-y: auto; padding-right: 10px; 
        }
        #historyList::-webkit-scrollbar, #adminUsersListDiv::-webkit-scrollbar { width: 8px; }
        #historyList::-webkit-scrollbar-track, #adminUsersListDiv::-webkit-scrollbar-track { background: #e9edf1; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb, #adminUsersListDiv::-webkit-scrollbar-thumb { background: #b0bec5; border-radius: 10px; }
        #historyList::-webkit-scrollbar-thumb:hover, #adminUsersListDiv::-webkit-scrollbar-thumb:hover { background: #90a4ae; }

        .tabs { margin-bottom: 25px; display: flex; justify-content: center; }
        .tabs button {
            padding: 12px 20px; margin: 0 8px;
            border: 1px solid #ced4da; background-color: #e9ecef;
            cursor: pointer; border-radius: var(--border-radius-md);
            font-weight: 600; font-size: 0.95em;
            transition: all 0.25s; color: var(--dark-text);
        }
        .tabs button:hover { background-color: #d8dde3; border-color: #b0bac4; }
        .tabs button.active {
            background-color: var(--primary-color); color: white;
            border-color: var(--primary-color);
            box-shadow: 0 3px 8px rgba(0,123,255,.3);
        }

        .result-modal-content { border-top: 4px solid var(--accent-color); }
        .result-icon {
            font-size: 4em; display: block; margin-bottom: 15px;
            animation: bounceIcon 1s ease-in-out infinite alternate;
        }
        @keyframes bounceIcon {
            from { transform: translateY(0px); }
            to { transform: translateY(-10px); }
        }
        .winnings-text {
            font-size: 1.3em; color: var(--dark-text); margin: 15px 0 25px 0;
        }
        .winnings-text strong {
            color: var(--success-color); font-weight: 700; font-size: 1.2em;
        }
        #collectWinningsBtn {
            background-color: var(--accent-color); color: var(--accent-text-color);
            font-weight: 700; width: auto; padding: 12px 30px;
        }
        #collectWinningsBtn:hover { background-color: var(--accent-hover-color); }

        .banner-ad-container-2 {
            width: 320px; height: 50px; margin: 20px auto; 
            display: none; overflow: hidden; text-align: center;
            background-color: #f0f0f0; border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="auth-container" id="authScreen">
        <h1>Welcome Back!</h1>
        <div id="authTabs" class="tabs">
            <button id="showLoginTabBtn" class="active">Login</button>
            <button id="showRegisterTabBtn">Register</button>
        </div>

        <div id="loginForm">
            <h2>Login to Your Account</h2>
            <input type="text" class="input-field" id="loginPhoneNumber" placeholder="Phone Number" required>
            <input type="text" class="input-field" id="loginName" placeholder="Your Name (as password)" required>
            <button class="auth-btn" id="loginBtn">Login</button>
        </div>

        <div id="registerForm" style="display: none;">
            <h2>Create New Account</h2>
            <input type="text" class="input-field" id="registerName" placeholder="Your Name" required>
            <input type="text" class="input-field" id="registerPhoneNumber" placeholder="Phone Number" required>
            <button class="auth-btn" id="registerBtn">Register</button>
        </div>

        <!-- Google Sign-In Button -->
        <div style="text-align: center; margin-top: 20px; margin-bottom:5px; color: #555;">OR</div>
        <button class="auth-btn" id="googleSignInBtn" style="background-color: #DB4437;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google G" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 10px;">
            Sign in with Google
        </button>
    </div>

    <!-- Main App Screen (Initially Hidden) -->
    <div class="container" id="appContainer" style="display: none;">
        <h1 id="welcomeMessage">Spin & Win Rewards</h1>
        <div class="coin-display" id="coinDisplay">Coins: 0 (‚Çπ0.00)</div>
        <button class="btn" id="spinBtn">üéâ Spin the Wheel! üéâ</button>
        <button class="btn" id="withdrawBtn">üí∏ Withdraw Coins</button>
        <button class="btn" id="historyBtn">üìú Withdrawal History</button>
        <button class="btn share-btn" id="shareAppBtn">üíå Share App</button>
        <button class="btn logout-btn" id="logoutBtn">üö™ Logout</button>
    </div>

    <!-- New Banner Ad Container (for the 320x50 ad) -->
    <div class="banner-ad-container-2" id="bannerAdContainer2">
        <!-- Ad script will be loaded here -->
    </div>
    
    <!-- Admin Panel (Initially Hidden) -->
    <div class="admin-panel" id="adminPanel" style="display: none;">
        <h2>üõ°Ô∏è Admin Panel</h2>
        <div class="tabs">
            <button id="adminWithdrawalsTab" class="active">Withdrawal Requests</button>
            <button id="adminUsersTab">Users List</button>
        </div>
        <div id="adminWithdrawalsContent">
            <h3>Pending Withdrawals</h3>
            <div id="withdrawalsList"></div>
        </div>
        <div id="adminUsersContent" style="display: none;">
            <h3>Registered Users</h3>
            <div id="adminUsersListDiv"></div>
        </div>
        <button class="btn" id="backToAppBtn" style="background-color: var(--secondary-color);">Back to App/Login</button>
    </div>
    <button class="admin-btn-fixed" id="adminAccessBtn">Admin</button>
    
    <!-- Spin Wheel Modal -->
    <div class="modal" id="spinModal">
        <div class="modal-content">
            <h2>Spin the Wheel!</h2>
            <div class="wheel-container">
                <div class="wheel" id="wheel">
                    <div class="wheel-center"></div> 
                </div>
                <div class="wheel-static-pointer"></div>
            </div>
            <p style="margin-top: 20px; font-size: 1em; color: #555;">Tap the wheel to spin for glory!</p>
            <button class="close-btn" id="closeSpinModalBtn">Close</button>
        </div>
    </div>

    <!-- Spin Result Modal -->
    <div class="modal" id="spinResultModal">
        <div class="modal-content result-modal-content">
            <span class="result-icon">üéâ</span>
            <h2>Woohoo!</h2>
            <p class="winnings-text">You've won <strong id="spinWinningsAmount">X</strong> coins!</p>
            <button class="btn" id="collectWinningsBtn">Awesome!</button>
        </div>
    </div>
    
    <!-- Withdraw Modal -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <h2>Withdraw Coins</h2>
            <p>Withdraw <strong>1000 coins (‚Çπ10.00)</strong>.</p>
            <p style="font-size:0.9em; color: #666;">Minimum balance of 1000 coins required.</p>
            <input type="text" class="input-field" id="upiIdInput" placeholder="Your UPI ID (e.g., name@okhdfcbank)">
            <button class="btn" id="submitWithdrawBtn" style="background-color: var(--success-color);">Submit Request (1000 Coins)</button>
            <button class="close-btn" id="closeWithdrawModalBtn">Cancel</button>
        </div>
    </div>

    <!-- Withdrawal History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h2>Withdrawal History</h2>
            <div id="historyList">
            </div>
            <button class="close-btn" id="closeHistoryModalBtn">Close</button>
        </div>
    </div>
    
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set, update, serverTimestamp as fbServerTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signOut as fbSignOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"; 

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyARQveKFG381gC1VH3HbroVBy9y2oH3wr0", // Replace with your actual API key
          authDomain: "d-earning-cfa42.firebaseapp.com",
          databaseURL: "https://d-earning-cfa42-default-rtdb.firebaseio.com",
          projectId: "d-earning-cfa42",
          storageBucket: "d-earning-cfa42.firebasestorage.app",
          messagingSenderId: "414626946856",
          appId: "1:414626946856:web:1c60a435f308673a84ba1d",
          measurementId: "G-VZFCMGEVHL" // Optional
        };

        // Initialize Firebase
        const fbApp = initializeApp(firebaseConfig);
        const db = getDatabase(fbApp);
        const auth = getAuth(fbApp);
        // const analytics = getAnalytics(fbApp); 

        // --- Global State & Constants ---
        let currentUser = null; // Firebase Auth user object
        let currentUserUid = null; // Firebase Auth User ID
        let currentUserPhoneNumber = null; // For phone-based login
        
        let usersData = {}; // Local cache for users
        let allWithdrawals = {}; // Local cache for withdrawals
        
        let isAdminView = false;
        let isSpinning = false;
        const FIXED_WITHDRAWAL_AMOUNT = 1000;
        const INITIAL_COINS = 100; 
        const ADMIN_PASSWORD = "@Dilshad4949E"; 

        // --- DOM Elements ---
        const authScreen = document.getElementById('authScreen');
        const appContainer = document.getElementById('appContainer');
        const adminPanel = document.getElementById('adminPanel');
        const bannerAdContainer2 = document.getElementById('bannerAdContainer2'); 

        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showLoginTabBtn = document.getElementById('showLoginTabBtn');
        const showRegisterTabBtn = document.getElementById('showRegisterTabBtn');

        const loginPhoneNumberInput = document.getElementById('loginPhoneNumber');
        const loginNameInput = document.getElementById('loginName');
        const loginBtn = document.getElementById('loginBtn');
        const registerNameInput = document.getElementById('registerName');
        const registerPhoneNumberInput = document.getElementById('registerPhoneNumber');
        const registerBtn = document.getElementById('registerBtn');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        const welcomeMessage = document.getElementById('welcomeMessage');
        const coinDisplay = document.getElementById('coinDisplay');
        const spinBtn = document.getElementById('spinBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const historyBtn = document.getElementById('historyBtn');
        const shareAppBtn = document.getElementById('shareAppBtn');
        
        const adminAccessBtn = document.getElementById('adminAccessBtn');
        const backToAppBtn = document.getElementById('backToAppBtn');
        const withdrawalsListDiv = document.getElementById('withdrawalsList'); 
        const adminUsersListDiv = document.getElementById('adminUsersListDiv');
        const adminWithdrawalsTab = document.getElementById('adminWithdrawalsTab');
        const adminUsersTab = document.getElementById('adminUsersTab');
        const adminWithdrawalsContent = document.getElementById('adminWithdrawalsContent');
        const adminUsersContent = document.getElementById('adminUsersContent');

        const spinModal = document.getElementById('spinModal');
        const spinResultModal = document.getElementById('spinResultModal'); 
        const spinWinningsAmount = document.getElementById('spinWinningsAmount'); 
        const collectWinningsBtn = document.getElementById('collectWinningsBtn'); 

        const withdrawModal = document.getElementById('withdrawModal');
        const historyModal = document.getElementById('historyModal');
        const closeSpinModalBtn = document.getElementById('closeSpinModalBtn');
        const closeWithdrawModalBtn = document.getElementById('closeWithdrawModalBtn');
        const closeHistoryModalBtn = document.getElementById('closeHistoryModalBtn');
        const submitWithdrawBtn = document.getElementById('submitWithdrawBtn');
        const upiIdInput = document.getElementById('upiIdInput');
        const wheel = document.getElementById('wheel');
        const historyListDiv = document.getElementById('historyList'); 

        const segments = [ 
            { text: '10', color: '#FF6384' }, { text: '20', color: '#36A2EB' },
            { text: '30', color: '#FFCE56' }, { text: '40', color: '#4BC0C0' },
            { text: '50', color: '#9966FF' }, { text: '60', color: '#FF9F40' },
            { text: '70', color: '#8AC249' }, { text: '80', color: '#EA5545' },
            { text: '90', color: '#F46A9B' }, { text: '100', color: '#EF9B20' } 
        ];
        const numSegments = segments.length;
        const anglePerSegment = 360 / numSegments;

        let popUpAdScriptLoaded = false; 
        let bannerAd2ScriptLoaded = false;

        // --- Helper Functions for User State ---
        function getCurrentUserDbKey() {
            if (currentUserUid) return currentUserUid;
            if (currentUserPhoneNumber) return currentUserPhoneNumber;
            return null;
        }

        function getCurrentUserData() {
            const key = getCurrentUserDbKey();
            return key && usersData[key] ? usersData[key] : null;
        }

        async function loadDataFromFirebase() {
            console.log("Attempting to load data from Firebase...");
            try {
                const usersSnapshot = await get(ref(db, 'users'));
                if (usersSnapshot.exists()) {
                    usersData = usersSnapshot.val();
                    console.log("Users data loaded:", usersData);
                } else {
                    usersData = {};
                    console.log("No users data found in Firebase.");
                }

                const withdrawalsSnapshot = await get(ref(db, 'withdrawals'));
                if (withdrawalsSnapshot.exists()) {
                    allWithdrawals = withdrawalsSnapshot.val();
                    console.log("Withdrawals data loaded:", allWithdrawals);
                } else {
                    allWithdrawals = {};
                    console.log("No withdrawals data found in Firebase.");
                }
            } catch (error) {
                console.error("Error loading data from Firebase:", error);
                alert("Could not connect to the database. Please check your internet connection and try again. Some features might not work.");
                usersData = {}; 
                allWithdrawals = {};
            }
        }
        
        function loadBannerAd2() {
            if (!bannerAd2ScriptLoaded && document.getElementById('bannerAdContainer2').style.display !== 'none') {
                const adOptions = {
                    'key' : '1a0cc19eb7e8ce411b4935f94fb33046',
                    'format' : 'iframe',
                    'height' : 50,
                    'width' : 320,
                    'params' : {}
                };
                const scriptTag = document.createElement('script');
                scriptTag.type = 'text/javascript';
                scriptTag.src = '//www.highperformanceformat.com/1a0cc19eb7e8ce411b4935f94fb33046/invoke.js';
                
                const adContainer = document.getElementById('bannerAdContainer2');
                window.atOptions = adOptions; 
                
                adContainer.innerHTML = ''; 
                adContainer.appendChild(scriptTag);
                bannerAd2ScriptLoaded = true;
                console.log("Banner Ad 2 (320x50) script loaded.");
            } else if (bannerAd2ScriptLoaded) {
                 console.log("Banner Ad 2 (320x50) script already loaded.");
            }
        }
        
        function loadPopUpAd() {
            if (!popUpAdScriptLoaded) { 
                const scriptTag = document.createElement('script');
                scriptTag.type = 'text/javascript';
                scriptTag.src = '//pl26601942.profitableratecpm.com/b6/72/39/b67239eda4e2ea035e63bcc1580654ed.js';
                document.body.appendChild(scriptTag);
                popUpAdScriptLoaded = true; 
                console.log("Pop-up ad script loaded.");
            } else {
                console.log("Pop-up ad script already loaded.");
            }
        }

        function showAuthScreen() {
            authScreen.style.display = 'block';
            appContainer.style.display = 'none';
            adminPanel.style.display = 'none';
            if (bannerAdContainer2) {
                bannerAdContainer2.style.display = 'block'; 
                loadBannerAd2();
            }
            adminAccessBtn.style.display = 'block'; 
            
            currentUser = null;
            currentUserUid = null;
            currentUserPhoneNumber = null; 
            sessionStorage.removeItem('spinWheelCurrentUser'); 

            loginForm.style.display = 'block'; 
            registerForm.style.display = 'none';
            showLoginTabBtn.classList.add('active');
            showRegisterTabBtn.classList.remove('active');
            updateCoinDisplayForCurrentUser(true); // Clear display
        }

        function showAppScreen() {
            authScreen.style.display = 'none';
            appContainer.style.display = 'block';
            adminPanel.style.display = 'none';
            if (bannerAdContainer2) {
                bannerAdContainer2.style.display = 'block'; 
                loadBannerAd2();
            }
            adminAccessBtn.style.display = 'block';
            
            const userData = getCurrentUserData();
            if (userData && userData.name) {
                welcomeMessage.textContent = `Welcome, ${userData.name.split(' ')[0]}!`;
            } else {
                welcomeMessage.textContent = "Spin & Win Rewards";
            }

            updateCoinDisplayForCurrentUser(true); 
            loadPopUpAd(); 
        }

        function showAdminPanel() {
            isAdminView = true;
            authScreen.style.display = 'none';
            appContainer.style.display = 'none';
            adminPanel.style.display = 'block';
            if (bannerAdContainer2) bannerAdContainer2.style.display = 'none'; 
            adminAccessBtn.style.display = 'none'; 
            renderAdminWithdrawals();
            renderAdminUsersList();
            adminWithdrawalsContent.style.display = 'block';
            adminUsersContent.style.display = 'none';
            adminWithdrawalsTab.classList.add('active');
            adminUsersTab.classList.remove('active');
        }
        
        showLoginTabBtn.addEventListener('click', () => {
            loginForm.style.display = 'block'; registerForm.style.display = 'none';
            showLoginTabBtn.classList.add('active'); showRegisterTabBtn.classList.remove('active');
        });
        showRegisterTabBtn.addEventListener('click', () => {
            loginForm.style.display = 'none'; registerForm.style.display = 'block';
            showRegisterTabBtn.classList.add('active'); showLoginTabBtn.classList.remove('active');
        });

        registerBtn.addEventListener('click', async () => {
            const name = registerNameInput.value.trim(); 
            const phone = registerPhoneNumberInput.value.trim();
            if (!name || !phone) { alert('Please enter both name and phone number.'); return; }
            if(!/^\d{10}$/.test(phone)){ alert('Please enter a valid 10-digit phone number.'); return; }
            
            if (usersData[phone]) { 
                alert('This phone number is already registered. Please login.'); return; 
            }

            const newUser = { 
                name: name, 
                phoneNumber: phone, 
                coins: INITIAL_COINS, 
                password: name, 
                registeredAt: fbServerTimestamp(),
                authProvider: "phone" 
            };

            try {
                await set(ref(db, 'users/' + phone), newUser);
                usersData[phone] = { ...newUser, registeredAt: Date.now(), authProvider: "phone" }; 
                
                currentUserPhoneNumber = phone; 
                sessionStorage.setItem('spinWheelCurrentUser', phone);
                currentUser = null; // Clear Firebase auth state
                currentUserUid = null;

                registerNameInput.value = ''; registerPhoneNumberInput.value = '';
                isAdminView = false; 
                showAppScreen();    
            } catch (error) {
                console.error("Error registering user:", error);
                alert("Registration failed. Please try again later.");
            }
        });

        loginBtn.addEventListener('click', () => {
            const phone = loginPhoneNumberInput.value.trim(); 
            const nameAsPassword = loginNameInput.value.trim();
            if (!phone || !nameAsPassword) { alert('Please enter phone number and your name (as password).'); return; }
            
            const user = usersData[phone]; 
            if (!user) { alert('Phone number not registered. Please register first.'); return; }
            if (user.password !== nameAsPassword) { alert('Incorrect name/password for this phone number.'); return; }
            
            currentUserPhoneNumber = phone; 
            sessionStorage.setItem('spinWheelCurrentUser', phone);
            currentUser = null; // Clear Firebase auth state
            currentUserUid = null;
            
            // Ensure authProvider is set if missing (for older users)
            if (!user.authProvider) {
                update(ref(db, 'users/' + phone), { authProvider: "phone" }).catch(console.error);
                usersData[phone].authProvider = "phone";
            }

            loginPhoneNumberInput.value = ''; loginNameInput.value = '';
            isAdminView = false; 
            showAppScreen();    
        });

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest (setting user, UID, checking RTDB, showing app screen)
                console.log("Google Sign-In successful, user:", result.user.displayName);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                if (error.code === 'auth/popup-closed-by-user') {
                    alert("Sign-in popup was closed. Please try again.");
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    alert("An account already exists with this email using a different sign-in method. Try that method or contact support if you wish to link accounts.");
                } else {
                    alert("Google Sign-In failed. Error: " + error.message);
                }
            }
        }
        googleSignInBtn.addEventListener('click', signInWithGoogle);

        logoutBtn.addEventListener('click', async () => {
            if (currentUserUid) { // If logged in via Firebase Auth (Google)
                try {
                    await fbSignOut(auth); // This will trigger onAuthStateChanged
                    console.log("Firebase Auth user signed out.");
                } catch (error) {
                    console.error("Error signing out from Firebase Auth:", error);
                    alert("Logout failed. Please try again.");
                }
            } else if (currentUserPhoneNumber) { // If logged in via old phone method
                sessionStorage.removeItem('spinWheelCurrentUser');
                currentUserPhoneNumber = null;
                // onAuthStateChanged will call showAuthScreen if no Firebase user is active.
                // For good measure, explicitly call if needed:
                 if (!auth.currentUser) showAuthScreen(); 
                console.log("Phone-based user logged out.");
            } else {
                 showAuthScreen(); // Should be handled by onAuthStateChanged but as a fallback
            }
        });


        function updateCoinDisplayForCurrentUser(isInitialLoad = false) {
            const userData = getCurrentUserData();

            if (userData) {
                const userCoins = userData.coins;
                const rupees = (userCoins / 100).toFixed(2); 
                coinDisplay.innerHTML = `Coins: ${userCoins} <span style="font-size:0.7em;">(‚Çπ${rupees})</span>`;
                if (!isInitialLoad) { 
                    coinDisplay.classList.add('coin-update-animation');
                    setTimeout(() => coinDisplay.classList.remove('coin-update-animation'), 600);
                }
                if(withdrawBtn) withdrawBtn.disabled = userCoins < FIXED_WITHDRAWAL_AMOUNT; 
                if(spinBtn) spinBtn.disabled = false;
            } else {
                coinDisplay.textContent = 'Coins: N/A'; 
                if(withdrawBtn) withdrawBtn.disabled = true; 
                if(spinBtn) spinBtn.disabled = true; 
            }
        }

        spinBtn.addEventListener('click', () => {
            if (!getCurrentUserDbKey()) { alert("Please login to spin."); return; }
            spinModal.style.display = 'flex';
        });
        
        withdrawBtn.addEventListener('click', () => {
            const userData = getCurrentUserData();
            if (!userData) { alert("Please login first."); return; }
            if (userData.coins < FIXED_WITHDRAWAL_AMOUNT) { alert(`You need at least ${FIXED_WITHDRAWAL_AMOUNT} coins to withdraw.`); return; }
            withdrawModal.style.display = 'flex';
        });

        historyBtn.addEventListener('click', showWithdrawalHistoryForUser); 
        shareAppBtn.addEventListener('click', handleShareApp);
        closeSpinModalBtn.addEventListener('click', () => spinModal.style.display = 'none');
        collectWinningsBtn.addEventListener('click', () => spinResultModal.style.display = 'none');
        closeWithdrawModalBtn.addEventListener('click', () => withdrawModal.style.display = 'none');
        closeHistoryModalBtn.addEventListener('click', () => historyModal.style.display = 'none');

        submitWithdrawBtn.addEventListener('click', async () => {
            const userDbKey = getCurrentUserDbKey();
            const userData = getCurrentUserData();

            if (!userDbKey || !userData) { alert("Error: Not logged in."); return; }
            
            const amountToWithdraw = FIXED_WITHDRAWAL_AMOUNT; 
            const upi = upiIdInput.value.trim();
            
            if (userData.coins < amountToWithdraw) { alert(`You don't have enough coins. Minimum ${amountToWithdraw} required.`); return; }
            if (!upi) { alert('Please enter your UPI ID.'); return; }
            if (!/^[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}$/.test(upi)) { alert('Please enter a valid UPI ID (e.g., yourname@bank).'); return; }

            const withdrawalId = "wd_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5);
            const newWithdrawal = { 
                id: withdrawalId, 
                userId: userDbKey, // UID for Google, Phone for phone-login
                userPhoneNumber: userData.phoneNumber || (currentUserPhoneNumber || 'N/A (Google User)'), // For admin reference
                userName: userData.name || userData.email || 'Unknown User',
                amount: amountToWithdraw, 
                upiId: upi, 
                status: 'pending', 
                timestamp: fbServerTimestamp() 
            };
            const newCoinsForUser = userData.coins - amountToWithdraw;

            try {
                await set(ref(db, 'withdrawals/' + withdrawalId), newWithdrawal);
                await update(ref(db, 'users/' + userDbKey), { coins: newCoinsForUser });

                if (!allWithdrawals) allWithdrawals = {};
                allWithdrawals[withdrawalId] = { ...newWithdrawal, timestamp: Date.now() }; 
                usersData[userDbKey].coins = newCoinsForUser; 

                updateCoinDisplayForCurrentUser(); 
                withdrawModal.style.display = 'none'; 
                upiIdInput.value = '';
                alert(`Withdrawal request for ${amountToWithdraw} coins submitted! Check history for status updates.`);
            } catch (error) {
                console.error("Error submitting withdrawal:", error);
                alert("Withdrawal request failed. Please try again later.");
            }
        });

        wheel.addEventListener('click', () => {
            if (!getCurrentUserDbKey()) { alert("Please login to spin."); return; }
            if (!isSpinning) spinWheel();
        });
        
        function createWheel() { 
            const existingTextContainers = wheel.querySelectorAll('.wheel-text-container');
            existingTextContainers.forEach(tc => tc.remove());
            let gradientParts = [];
            segments.forEach((segment, i) => {
                const startAngle = i * anglePerSegment;
                const endAngle = (i + 1) * anglePerSegment;
                gradientParts.push(`${segment.color} ${startAngle}deg ${endAngle}deg`);
                const textContainer = document.createElement('div');
                textContainer.className = 'wheel-text-container';
                const segmentMiddleAngle = startAngle + (anglePerSegment / 2);
                textContainer.style.transform = `rotate(${segmentMiddleAngle}deg)`;
                const textSpan = document.createElement('span');
                textSpan.className = 'wheel-text-content';
                textSpan.textContent = segment.text;
                textContainer.appendChild(textSpan);
                wheel.appendChild(textContainer); 
            });
            wheel.style.background = `conic-gradient(${gradientParts.join(', ')})`;
        }
        
        function spinWheel() { 
            const userDbKey = getCurrentUserDbKey();
            const userData = getCurrentUserData();

            if (isSpinning || !userDbKey || !userData) return;

            isSpinning = true; spinBtn.disabled = true; wheel.style.pointerEvents = 'none';
            const minRotations = 5; const randomExtraDegrees = Math.floor(Math.random() * 360);
            const totalSpinDegrees = (minRotations * 360) + randomExtraDegrees;
            wheel.style.transition = 'transform 4s cubic-bezier(0.22, 0.61, 0.36, 1)'; 
            wheel.style.transform = `rotate(${totalSpinDegrees}deg)`;

            setTimeout(async () => { 
                const effectiveWheelRotation = totalSpinDegrees % 360; 
                const pointerOffsetAngle = 270; 
                let winningAngle = (pointerOffsetAngle - (effectiveWheelRotation % 360) + 360) % 360;
                const winningSegmentIndex = Math.floor(winningAngle / anglePerSegment);
                const prize = parseInt(segments[winningSegmentIndex].text);

                const currentCoinTotal = usersData[userDbKey].coins; // Get latest from local cache
                const newCoinTotal = currentCoinTotal + prize;
                try {
                    await update(ref(db, 'users/' + userDbKey), { coins: newCoinTotal });
                    usersData[userDbKey].coins = newCoinTotal; 
                    updateCoinDisplayForCurrentUser(); 
                } catch (error) {
                    console.error("Error updating coins after spin:", error);
                    alert("Failed to save your winnings due to a network issue. Please check connection.");
                }
                
                spinWinningsAmount.textContent = prize; 
                spinResultModal.style.display = 'flex'; 
                spinModal.style.display = 'none'; 
                
                setTimeout(() => {
                    wheel.style.transition = 'none'; 
                    wheel.style.transform = `rotate(${effectiveWheelRotation % 360}deg)`; 
                    setTimeout(() => {
                        wheel.style.transition = 'transform 4s cubic-bezier(0.22, 0.61, 0.36, 1)'; 
                        wheel.style.pointerEvents = 'auto'; 
                        isSpinning = false; 
                        spinBtn.disabled = false; 
                    }, 50); 
                }, 500); 
            }, 4100); 
        }

        async function handleShareApp() {
            const shareData = { title: 'D-earning App', text: 'üí∞ Spin the wheel and earn real rewards with D-earning App! Join me now: ', url: window.location.href };
            if (navigator.share) { 
                try { await navigator.share(shareData); console.log('App shared successfully'); } 
                catch (err) { console.error('Error sharing:', err); if (err.name !== 'AbortError') { alert('Could not share. You can copy the link from the address bar.'); } } 
            }
            else if (navigator.clipboard && navigator.clipboard.writeText) { 
                try { await navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`); alert('Link copied to clipboard! Share it with your friends.'); } 
                catch (err) { console.error('Failed to copy link:', err); alert('Sharing not fully supported. Please copy the link manually: ' + shareData.url); } 
            }
            else { alert('Sharing not supported on this browser. Please copy the link manually: ' + shareData.url); }
        }

        function showWithdrawalHistoryForUser() { 
            const userDbKey = getCurrentUserDbKey();
            if (!userDbKey) { alert("Please login to view history."); return; } 
            renderUserHistory(); 
            historyModal.style.display = 'flex'; 
        }

        function renderUserHistory() {
            historyListDiv.innerHTML = ''; 
            const userDbKey = getCurrentUserDbKey();
            if (!userDbKey) { historyListDiv.innerHTML = '<p>Please log in.</p>'; return; }

            const userWithdrawalsArray = Object.values(allWithdrawals || {})
                                            .filter(w => w.userId === userDbKey) // Filter by the consistent userId
                                            .sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (userWithdrawalsArray.length === 0) { 
                historyListDiv.innerHTML = '<p>No withdrawal history yet.</p>'; return; 
            }
            
            userWithdrawalsArray.forEach(withdrawal => {
                const item = document.createElement('div'); item.className = 'history-item';
                const rupees = (withdrawal.amount / 100).toFixed(2); 
                let statusClass = `status-${withdrawal.status}`;
                const dateString = withdrawal.timestamp ? new Date(withdrawal.timestamp).toLocaleString() : 'Processing...';
                item.innerHTML = `<p><strong>Amount:</strong> ${withdrawal.amount} coins (‚Çπ${rupees})</p>
                                  <p><strong>UPI ID:</strong> ${withdrawal.upiId}</p>
                                  <p><strong>Date:</strong> ${dateString}</p>
                                  <p><strong>Status:</strong> <span class="${statusClass}" style="font-weight:bold;">${withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1)}</span></p>`;
                historyListDiv.appendChild(item);
            });
        }

        adminAccessBtn.addEventListener('click', () => {
            const enteredPassword = prompt("Enter Admin Password:");
            if (enteredPassword === ADMIN_PASSWORD) { showAdminPanel(); } 
            else if (enteredPassword !== null) { alert("Incorrect admin password."); }
        });

        backToAppBtn.addEventListener('click', () => {
            isAdminView = false; 
            if (getCurrentUserDbKey() && getCurrentUserData()) { showAppScreen(); } 
            else { showAuthScreen(); }
        });

        adminWithdrawalsTab.addEventListener('click', () => {
            adminWithdrawalsContent.style.display = 'block'; adminUsersContent.style.display = 'none';
            adminWithdrawalsTab.classList.add('active'); adminUsersTab.classList.remove('active');
        });

        adminUsersTab.addEventListener('click', () => {
            adminWithdrawalsContent.style.display = 'none'; adminUsersContent.style.display = 'block';
            adminUsersTab.classList.add('active'); adminWithdrawalsTab.classList.remove('active'); 
            renderAdminUsersList(); 
        });

        function renderAdminWithdrawals() { 
            withdrawalsListDiv.innerHTML = ''; 
            const allWithdrawalsArray = Object.values(allWithdrawals || {})
                                           .sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)); 

            if (allWithdrawalsArray.length === 0) { 
                withdrawalsListDiv.innerHTML = '<p>No withdrawal requests</p>'; return; 
            }
            
            allWithdrawalsArray.forEach(withdrawal => {
                const item = document.createElement('div'); item.className = 'withdrawal-item';
                const rupees = (withdrawal.amount / 100).toFixed(2); 
                let actionButtons = '';
                if (withdrawal.status === 'pending') { 
                    actionButtons = `<button class="action-btn approve-btn" data-id="${withdrawal.id}">Approve</button>
                                     <button class="action-btn reject-btn" data-id="${withdrawal.id}">Reject</button>`; 
                }
                let statusClass = `status-${withdrawal.status}`; 
                // Use withdrawal.userName directly, or lookup if needed and available
                const userName = withdrawal.userName || (usersData[withdrawal.userId] ? (usersData[withdrawal.userId].name || usersData[withdrawal.userId].email) : 'N/A');
                const userIdentifier = withdrawal.userPhoneNumber !== 'N/A (Google User)' ? withdrawal.userPhoneNumber : withdrawal.userId;
                const dateString = withdrawal.timestamp ? new Date(withdrawal.timestamp).toLocaleString() : 'Processing...';
                
                item.innerHTML = `<p><strong>User:</strong> ${userName} (${userIdentifier})</p>
                                  <p><strong>ID:</strong> ${withdrawal.id}</p>
                                  <p><strong>Amount:</strong> ${withdrawal.amount} coins (‚Çπ${rupees})</p>
                                  <p><strong>UPI ID:</strong> ${withdrawal.upiId}</p>
                                  <p><strong>Date:</strong> ${dateString}</p>
                                  <p><strong>Status:</strong> <span class="${statusClass}" style="font-weight:bold;">${withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1)}</span></p>
                                  ${actionButtons}`;
                withdrawalsListDiv.appendChild(item);
            });
            document.querySelectorAll('#adminWithdrawalsContent .action-btn').forEach(btn => { btn.addEventListener('click', handleAdminAction); });
        }

        async function handleAdminAction(e) { 
            const withdrawalId = e.target.getAttribute('data-id'); 
            const action = e.target.classList.contains('approve-btn') ? 'approved' : 'rejected';
            
            const withdrawalToUpdate = allWithdrawals[withdrawalId];

            if (withdrawalToUpdate && withdrawalToUpdate.status === 'pending') {
                try {
                    await update(ref(db, 'withdrawals/' + withdrawalId), { status: action });
                    allWithdrawals[withdrawalId].status = action; 

                    if (action === 'rejected') {
                        const userToRefundDbKey = withdrawalToUpdate.userId; // This should be the key to usersData
                        const userToRefund = usersData[userToRefundDbKey];
                        if (userToRefund) { 
                            const newCoinsForUser = userToRefund.coins + withdrawalToUpdate.amount;
                            await update(ref(db, 'users/' + userToRefundDbKey), { coins: newCoinsForUser });
                            userToRefund.coins = newCoinsForUser; 
                            alert(`Withdrawal ID ${withdrawalId} for ${userToRefund.name || userToRefund.email} rejected. ${withdrawalToUpdate.amount} coins refunded.`); 
                        } else { 
                            alert(`Withdrawal ID ${withdrawalId} rejected. User ${userToRefundDbKey} not found for refund, but status updated.`); 
                        }
                    } else { 
                        const userNameForAlert = usersData[withdrawalToUpdate.userId]?.name || usersData[withdrawalToUpdate.userId]?.email || withdrawalToUpdate.userId;
                        alert(`Withdrawal ID ${withdrawalId} for ${userNameForAlert} approved.`); 
                    }
                    renderAdminWithdrawals(); 
                } catch (error) {
                    console.error("Error updating withdrawal status:", error);
                    alert("Failed to update withdrawal status. Please try again.");
                }
            }
        }

        function renderAdminUsersList() {
            adminUsersListDiv.innerHTML = ''; 
            const userEntries = Object.entries(usersData || {}); // Get [key, value] pairs

            if (userEntries.length === 0) { 
                adminUsersListDiv.innerHTML = '<p>No registered users.</p>'; return; 
            }
            
            // Sort by name, fallback to email or key
            userEntries.sort(([,a], [,b]) => {
                const nameA = a.name || a.email || "";
                const nameB = b.name || b.email || "";
                return nameA.localeCompare(nameB);
            }); 
            
            userEntries.forEach(([key, user]) => { // key is UID or phone number
                const item = document.createElement('div'); item.className = 'user-list-item';
                const rupees = (user.coins / 100).toFixed(2);
                const regDate = user.registeredAt ? new Date(user.registeredAt).toLocaleDateString() : 'N/A';
                const displayName = user.name || user.email || "Unknown User";
                const displayIdentifier = user.phoneNumber || key; // Show phone if available, else the key (UID)

                item.innerHTML = `<p><strong>Name:</strong> ${displayName}</p>
                                  <p><strong>Identifier:</strong> ${displayIdentifier}</p>
                                  <p><strong>Coins:</strong> ${user.coins} (‚Çπ${rupees})</p>
                                  <p><strong>Registered:</strong> ${regDate}</p>
                                  <p><strong>Auth:</strong> ${user.authProvider || 'Unknown'}</p>`;
                adminUsersListDiv.appendChild(item);
            });
        }

        // --- Initial App Logic ---
        async function initializeAppLogic() {
            document.body.style.cursor = 'wait'; 
            await loadDataFromFirebase(); // Load all users and withdrawals first
            createWheel(); 

            onAuthStateChanged(auth, async (firebaseUser) => {
                document.body.style.cursor = 'wait'; 
                if (firebaseUser) {
                    // Google User is signed in
                    currentUser = firebaseUser;
                    currentUserUid = firebaseUser.uid;
                    currentUserPhoneNumber = null; // Clear phone session if Google user logs in
                    sessionStorage.removeItem('spinWheelCurrentUser');
                    console.log("Firebase Auth User (Google) signed in:", firebaseUser.displayName, firebaseUser.uid);

                    if (!usersData[currentUserUid]) {
                        console.log("New Google user. Creating profile in RTDB...");
                        const newUserProfile = {
                            name: firebaseUser.displayName || "Google User",
                            email: firebaseUser.email,
                            coins: INITIAL_COINS,
                            phoneNumber: firebaseUser.phoneNumber || null, // Google might provide phone sometimes
                            registeredAt: fbServerTimestamp(),
                            authProvider: "google"
                        };
                        try {
                            await set(ref(db, 'users/' + currentUserUid), newUserProfile);
                            usersData[currentUserUid] = { ...newUserProfile, registeredAt: Date.now(), authProvider: "google" };
                            console.log("New Google user profile created in RTDB:", usersData[currentUserUid]);
                        } catch (error) {
                            console.error("Error creating Google user profile in RTDB:", error);
                            alert("Could not save your profile. Please try again.");
                            await fbSignOut(auth); // Sign out if profile creation fails
                            document.body.style.cursor = 'default';
                            return;
                        }
                    } else {
                         // Ensure authProvider is set if missing (for older users who might have UID as key already)
                        if (!usersData[currentUserUid].authProvider) {
                            update(ref(db, 'users/' + currentUserUid), { authProvider: "google" }).catch(console.error);
                            usersData[currentUserUid].authProvider = "google";
                        }
                        console.log("Existing Google user profile found in RTDB:", usersData[currentUserUid].name);
                    }
                    showAppScreen();
                } else {
                    // No Firebase Auth user (Google user signed out or never signed in)
                    currentUser = null;
                    currentUserUid = null;
                    
                    // Check for existing phone-based session
                    const loggedInUserPhone = sessionStorage.getItem('spinWheelCurrentUser');
                    if (loggedInUserPhone && usersData[loggedInUserPhone]) {
                        currentUserPhoneNumber = loggedInUserPhone;
                        console.log("Phone-based user session active:", currentUserPhoneNumber);
                        showAppScreen();
                    } else {
                        currentUserPhoneNumber = null; // Ensure it's cleared
                        console.log("No active user session (Google or Phone). Showing auth screen.");
                        showAuthScreen();
                    }
                }
                updateCoinDisplayForCurrentUser(true);
                document.body.style.cursor = 'default';
            });
        }

        initializeAppLogic(); // Start the app

    </script>
</body>
</html>